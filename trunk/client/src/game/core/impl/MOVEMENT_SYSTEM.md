# MovementSystem - War3 é£æ ¼ç§»åŠ¨ç³»ç»Ÿ

å‚è€ƒé­”å…½äº‰éœ¸3çš„ç§»åŠ¨æœºåˆ¶å®ç°çš„å®Œæ•´ç§»åŠ¨ç³»ç»Ÿã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### 1. A* å¯»è·¯ç®—æ³•
- åŸºäºåœ°å›¾æ ¼å­çš„ A* å¯»è·¯
- æ”¯æŒ 8 æ–¹å‘ç§»åŠ¨ï¼ˆä¸Šä¸‹å·¦å³ + 4ä¸ªå¯¹è§’çº¿ï¼‰
- è‡ªåŠ¨é¿å¼€é˜»æŒ¡åŒºåŸŸ
- ä½¿ç”¨æ›¼å“ˆé¡¿è·ç¦»å¯å‘å¼å‡½æ•°
- è¾¹ç•Œæ£€æŸ¥å’Œç›®æ ‡å¯è¾¾æ€§æ£€æµ‹

### 2. è·¯å¾„å¹³æ»‘
- è‡ªåŠ¨ä¼˜åŒ–ç”Ÿæˆçš„è·¯å¾„
- ä½¿ç”¨è§†çº¿æ£€æµ‹ï¼ˆLine of Sightï¼‰è¿›è¡Œè·¯å¾„ç®€åŒ–
- ç§»é™¤ä¸å¿…è¦çš„è·¯å¾„ç‚¹
- ç”Ÿæˆæ›´è‡ªç„¶æµç•…çš„ç§»åŠ¨è½¨è¿¹

### 3. å¹³æ»‘è½¬å‘ç³»ç»Ÿ
- æ¸è¿›å¼æ—‹è½¬ï¼Œè€Œéç¬é—´è½¬å‘
- å¯é…ç½®è½¬å‘é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰
- è‡ªåŠ¨è®¡ç®—æœ€çŸ­æ—‹è½¬è·¯å¾„
- ç±»ä¼¼ War3 çš„è½¬å‘æ•ˆæœ

### 4. ç²¾ç¡®åˆ°è¾¾åˆ¤å®š
- å¯é…ç½®åˆ°è¾¾åŠå¾„ï¼ˆarrivalRadiusï¼‰
- é¿å…ç›®æ ‡ç‚¹"éœ‡è¡"é—®é¢˜
- æ”¯æŒè·¯å¾„ç‚¹åºåˆ—è·Ÿéš
- è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè·¯å¾„ç‚¹

### 5. ç§»åŠ¨çŠ¶æ€ç®¡ç†
```typescript
enum MoveState {
    Idle = 'idle',              // å¾…æœº
    MovingStraight = 'moving_straight',  // ç›´çº¿ç§»åŠ¨
    Moving = 'moving',          // A* è·¯å¾„è·Ÿéš
    Turning = 'turning',        // è½¬å‘ä¸­
    Blocked = 'blocked',        // è¢«é˜»æŒ¡
    Arrived = 'arrived',        // å·²åˆ°è¾¾
}
```

## ğŸ® War3 é£æ ¼ç›´çº¿è¿åŠ¨ä¼˜åŒ–

### ç§»åŠ¨ç­–ç•¥ï¼ˆå®Œå…¨War3åŒ–ï¼‰

MovementSystem å®ç°äº†å®Œæ•´çš„ War3 é£æ ¼ç§»åŠ¨ç³»ç»Ÿï¼š

**ç¬¬ä¸€é˜¶æ®µï¼šç›´çº¿è¿åŠ¨å°è¯•**
```
1. æ”¶åˆ° moveTo() å‘½ä»¤
2. æ£€æŸ¥ç›®æ ‡ç‚¹ç›´çº¿è·¯å¾„æ˜¯å¦é€šè¡Œ
3. å¦‚æœé€šè¡Œ â†’ è¿›å…¥ MovingStraight çŠ¶æ€
4. ç›´æ¥æœç›®æ ‡è¿åŠ¨
```

**ç¬¬äºŒé˜¶æ®µï¼šæ¯å¸§åŠ¨æ€éšœç¢æ£€æµ‹**
```
1. æ¯å¸§æ£€æŸ¥å‰æ–¹ 0.5m æ˜¯å¦æœ‰æ–°çš„éšœç¢
2. å¦‚æœæœ‰éšœç¢ â†’ ç«‹å³åˆ‡æ¢åˆ° Moving çŠ¶æ€
3. è‡ªåŠ¨è°ƒç”¨ A* å¯»è·¯ç»•è·¯
```

**ç¬¬ä¸‰é˜¶æ®µï¼šè·¯å¾„è·Ÿéš**
```
1. æ²¿ A* è·¯å¾„ç§»åŠ¨
2. è‡ªåŠ¨ç§»é™¤ä¸å¿…è¦çš„è·¯å¾„ç‚¹ï¼ˆè·¯å¾„å¹³æ»‘ï¼‰
3. ç›´åˆ°åˆ°è¾¾ç›®æ ‡
```

### çŠ¶æ€è½¬æ¢å›¾

```
idle
  â†“
moveTo() å‘½ä»¤
  â†“
[æ£€æŸ¥ç›´çº¿]
  â”œâ”€ é€šè¡Œ â†’ MovingStraight
  â”‚         â†“ (æ¯å¸§æ£€æµ‹)
  â”‚         æœ‰éšœç¢ â†’ Moving (A*)
  â”‚                  â†“
  â”‚                å·²åˆ°è¾¾ â†’ Arrived
  â”‚
  â””â”€ ä¸é€šè¡Œ â†’ Moving (A*) 
             â†“
             å·²åˆ°è¾¾ â†’ Arrived
```

### æ ¸å¿ƒä¼˜åŒ–ç‚¹

1. **å‡å°‘å¯»è·¯è®¡ç®—**: ä¼˜å…ˆç›´çº¿èµ°ï¼Œåªåœ¨å¿…è¦æ—¶è°ƒç”¨A*
2. **å“åº”å¼éšœç¢æ£€æµ‹**: æ¯å¸§0.5mé¢„æ£€ï¼Œç«‹å³ååº”è€Œä¸æ˜¯èµ°åˆ°å¢™
3. **è‡ªåŠ¨è·¯å¾„ä¼˜åŒ–**: è·¯å¾„å¹³æ»‘ç§»é™¤å†—ä½™ç‚¹
4. **å¹³æ»‘è½¬å‘**: é€å¸§æ—‹è½¬è€Œéç¬é—´è½¬å‘

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```typescript
import { MovementSystem } from './MovementSystem';

const game = runner.getGame();
const movement = game.getSystem<MovementSystem>('movement');

// ç§»åŠ¨å•ä½åˆ°ç›®æ ‡ä½ç½®
movement?.moveTo({
    actorId: 'unit_1',
    targetX: 100,
    targetZ: 100,
    speed: 5,  // 5 ç±³/ç§’
});
```

### å¸¦å‚æ•°çš„ç§»åŠ¨

```typescript
movement?.moveTo({
    actorId: 'unit_1',
    targetX: 200,
    targetZ: 150,
    speed: 8,
    arrivalRadius: 1.0,  // åˆ°è¾¾åŠå¾„ 1 ç±³
    turnSpeed: 180,      // è½¬å‘é€Ÿåº¦ 180 åº¦/ç§’
    targetY: 0,          // ç›®æ ‡é«˜åº¦ï¼ˆå¯é€‰ï¼‰
});
```

### æ£€æŸ¥ç§»åŠ¨çŠ¶æ€

```typescript
// æ£€æŸ¥æ˜¯å¦åœ¨ç§»åŠ¨
const isMoving = movement.isMoving('unit_1');

// è·å–è¯¦ç»†çŠ¶æ€
const state = movement.getMoveState('unit_1');
// è¿”å›: 'idle' | 'moving_straight' | 'moving' | 'turning' | 'blocked' | 'arrived' | null
```

### åœæ­¢ç§»åŠ¨

```typescript
movement.stopMove('unit_1');
```

## ğŸ® ä¸ UnitCommandSystem é›†æˆ

MovementSystem è‡ªåŠ¨ä¸ UnitCommandSystem é›†æˆï¼š

```typescript
const commandSystem = game.getSystem('unitCommand');

// MoveTo å‘½ä»¤
commandSystem.issueCommand('unit_1', {
    type: 'MoveTo',
    targetPos: { x: 100, y: 100 }, // y å¯¹åº”ä¸–ç•Œåæ ‡çš„ z
});

// AttackMove å‘½ä»¤
commandSystem.issueCommand('unit_2', {
    type: 'AttackMove',
    targetPos: { x: 200, y: 150 },
});
```

## ğŸ“ åæ ‡ç³»ç»Ÿ

MovementSystem ä½¿ç”¨ä¸–ç•Œåæ ‡ç³»ï¼š
- `x`: æ°´å¹³ä½ç½®ï¼ˆç±³ï¼‰
- `y`: é«˜åº¦ï¼ˆç±³ï¼‰
- `z`: æ·±åº¦ï¼ˆç±³ï¼‰

æ³¨æ„ï¼šUnitCommandSystem ä¸­çš„ `targetPos.y` å¯¹åº”ä¸–ç•Œåæ ‡çš„ `z`ã€‚

## âš™ï¸ é…ç½®å‚æ•°

### MoveCommand æ¥å£

```typescript
interface MoveCommand {
    actorId: string;        // å•ä½ ID
    targetX: number;        // ç›®æ ‡ X åæ ‡ï¼ˆç±³ï¼‰
    targetZ: number;        // ç›®æ ‡ Z åæ ‡ï¼ˆç±³ï¼‰
    targetY?: number;       // ç›®æ ‡é«˜åº¦ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 0ï¼‰
    speed: number;          // ç§»åŠ¨é€Ÿåº¦ï¼ˆç±³/ç§’ï¼‰
    arrivalRadius?: number; // åˆ°è¾¾åŠå¾„ï¼ˆé»˜è®¤ 0.1 ç±³ï¼‰
    turnSpeed?: number;     // è½¬å‘é€Ÿåº¦ï¼ˆé»˜è®¤ 360 åº¦/ç§’ï¼‰
}
```

### ç³»ç»Ÿé»˜è®¤é…ç½®

```typescript
private _defaultArrivalRadius = 0.1;  // é»˜è®¤åˆ°è¾¾åŠå¾„ï¼ˆç±³ï¼‰
private _defaultTurnSpeed = 360;      // é»˜è®¤è½¬å‘é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰
private _pathSmoothRadius = 1.0;      // è·¯å¾„å¹³æ»‘æ£€æµ‹åŠå¾„
private _collisionRadius = 0.5;       // ç¢°æ’åŠå¾„ï¼ˆç”¨äºRVOï¼‰
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿç»„æˆ

```
MovementSystem
â”œâ”€â”€ A* å¯»è·¯æ¨¡å—
â”‚   â”œâ”€â”€ å¼€æ”¾åˆ—è¡¨ç®¡ç†
â”‚   â”œâ”€â”€ å¯å‘å¼è®¡ç®—
â”‚   â””â”€â”€ è·¯å¾„é‡å»º
â”œâ”€â”€ è·¯å¾„å¹³æ»‘æ¨¡å—
â”‚   â”œâ”€â”€ è§†çº¿æ£€æµ‹
â”‚   â””â”€â”€ è·¯å¾„ç®€åŒ–
â”œâ”€â”€ ç§»åŠ¨æ§åˆ¶æ¨¡å—
â”‚   â”œâ”€â”€ ç›´çº¿ç§»åŠ¨ï¼ˆæ–°ï¼‰
â”‚   â”œâ”€â”€ è·¯å¾„ç‚¹è·Ÿéš
â”‚   â”œâ”€â”€ é€Ÿåº¦æ§åˆ¶
â”‚   â””â”€â”€ åˆ°è¾¾åˆ¤å®š
â””â”€â”€ è½¬å‘æ§åˆ¶æ¨¡å—
    â”œâ”€â”€ è§’åº¦æ’å€¼
    â””â”€â”€ æœ€çŸ­æ—‹è½¬è·¯å¾„
```

### æ•°æ®æµ

```
UnitCommandSystem
    â†“
MovementSystem.moveTo()
    â†“
[æ£€æŸ¥ç›´çº¿] â†’ ç›´çº¿é€šè¡Œ
    â†“
MovingStraight çŠ¶æ€ â†’ æ¯å¸§æ£€æµ‹
    â†“ (æœ‰éšœç¢)
A* å¯»è·¯ â†’ ç”Ÿæˆè·¯å¾„
    â†“
è·¯å¾„å¹³æ»‘ â†’ ä¼˜åŒ–è·¯å¾„
    â†“
fixedUpdate() â†’ è·¯å¾„è·Ÿéš
    â†“
Actor.move() + Actor.setRotation()
```

## ğŸ”„ æ›´æ–°æµç¨‹

åœ¨æ¯ä¸ªå›ºå®šå¸§ï¼ˆfixedUpdateï¼‰ä¸­ï¼š

1. éå†æ‰€æœ‰ç§»åŠ¨ä¸­çš„å•ä½
2. æ£€æŸ¥å•ä½çŠ¶æ€ï¼ˆæ´»è·ƒã€å­˜æ´»ï¼‰
3. æ ¹æ®çŠ¶æ€æ‰§è¡Œå¯¹åº”é€»è¾‘ï¼š
   - `MovingStraight`: ç›´çº¿ç§»åŠ¨ï¼Œæ¯å¸§æ£€æµ‹å‰æ–¹éšœç¢
   - `Moving`: å‘å½“å‰è·¯å¾„ç‚¹ç§»åŠ¨ï¼Œæ›´æ–°ä½ç½®å’Œæœå‘
   - `Turning`: å¹³æ»‘æ—‹è½¬è‡³ç›®æ ‡è§’åº¦
   - `Blocked`/`Arrived`: çŠ¶æ€æœºè¦†ç›–ï¼Œç­‰å¾…æ¸…ç†
4. æ£€æŸ¥åˆ°è¾¾æ¡ä»¶ï¼š
   - è·ç¦»è·¯å¾„ç‚¹ < arrivalRadius
   - åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªè·¯å¾„ç‚¹
   - æ‰€æœ‰è·¯å¾„ç‚¹å®Œæˆ â†’ çŠ¶æ€å˜ä¸º `Arrived`

## ğŸ†š ä¸ War3 çš„å¯¹æ¯”

| åŠŸèƒ½ç‰¹æ€§ | War3 | MovementSystem | å¤‡æ³¨ |
|---------|------|----------------|------|
| A* å¯»è·¯ | âœ… | âœ… | å®Œå…¨å®ç° |
| è·¯å¾„å¹³æ»‘ | âœ… | âœ… | å®Œå…¨å®ç° |
| å¹³æ»‘è½¬å‘ | âœ… | âœ… | å®Œå…¨å®ç° |
| åˆ°è¾¾åˆ¤å®š | âœ… | âœ… | å®Œå…¨å®ç° |
| 8æ–¹å‘ç§»åŠ¨ | âœ… | âœ… | å®Œå…¨å®ç° |
| ç›´çº¿è¿åŠ¨ | âœ… | âœ… | å®Œå…¨å®ç° (v1.1) |
| å•ä½é¿è®© | âœ… | âŒ | è®¡åˆ’ä¸­ |
| ç¼–é˜Ÿç§»åŠ¨ | âœ… | âŒ | è®¡åˆ’ä¸­ |
| Flow Field | âœ… | âŒ | è®¡åˆ’ä¸­ |
| åœ°å½¢é«˜åº¦ | âœ… | âš ï¸ | åŸºç¡€æ”¯æŒ |
| åŠ¨æ€éšœç¢ç‰© | âœ… | âŒ | è®¡åˆ’ä¸­ |

## ğŸ› å·²çŸ¥é™åˆ¶ä¸æ”¹è¿›è®¡åˆ’

### å½“å‰é™åˆ¶
1. **æ— å•ä½ç¢°æ’é¿è®©**: å¤šä¸ªå•ä½å¯èƒ½é‡å ï¼ˆRVOå¾…å®ç°ï¼‰
2. **æ— ç¼–é˜Ÿæ”¯æŒ**: å•ä½ç‹¬ç«‹ç§»åŠ¨
3. **é™æ€åœ°å›¾**: ä¸æ”¯æŒåŠ¨æ€éšœç¢ç‰©ï¼ˆä¸´æ—¶ï¼‰
4. **å¹³é¢è¿åŠ¨**: æœªå®ç°åœ°å½¢é«˜åº¦ç›¸å…³çš„è¿åŠ¨

### æ”¹è¿›æ–¹å‘ (ä¼˜å…ˆçº§æ’åº)

#### â­ é«˜ä¼˜å…ˆçº§ï¼šå•ä½é¿è®©ç³»ç»Ÿ (RVO)
```typescript
interface AvoidanceSystem {
    // è®¡ç®—é¿è®©é€Ÿåº¦ï¼ŒåŸºäºå‘¨å›´å•ä½
    computeAvoidanceVelocity(unit: Actor, neighbors: Actor[], targetVelocity: Vector2): Vector2;
    
    // è·å–å‘¨å›´é‚»å±…
    getNearbyUnits(unit: Actor, radius: number): Actor[];
    
    // åº”ç”¨é¿è®©åˆ°ç§»åŠ¨ç³»ç»Ÿ
    applyRVO(moveData: MoveData, deltaSeconds: number): void;
}
```
**ä¼˜åŠ¿**ï¼š
- å¤šå•ä½è‡ªç„¶é¿è®©ï¼Œæ— éœ€æå‰è§„åˆ’
- è®¡ç®—é‡å°ï¼Œæ¯å•ä½O(n)ï¼ˆnä¸ºé‚»å±…æ•°ï¼‰
- å®ç°War3çš„è‡ªç„¶æ‹¥æŒ¤æ•ˆæœ
- å¯å¤ç”¨ç°æœ‰çš„å•ä½radiuså­—æ®µ

#### ç¼–é˜Ÿç§»åŠ¨
```typescript
interface Formation {
    leader: Actor;
    followers: Actor[];
    formationType: 'line' | 'wedge' | 'box' | 'circle';
    offset: Vector3[]; // ç›¸å¯¹é¢†é˜Ÿçš„ä½ç§»
}
```

#### Flow Field å¤§è§„æ¨¡ä¼˜åŒ–
ç”¨äº100+å•ä½åŒæ—¶ç§»åŠ¨ï¼š
- ç”Ÿæˆå…¨å±€åŠ¿èƒ½åœº
- å•ä½è·Ÿéšæ¢¯åº¦å‘ä¸‹ï¼ˆæœç›®æ ‡ï¼‰
- å¤§å¹…å‡å°‘A*è°ƒç”¨æ¬¡æ•°

#### åŠ¨æ€éšœç¢ç‰©
- å»ºç­‘åˆ›å»º/é”€æ¯æ—¶æ›´æ–°å¯é€šè¡Œæ€§
- ä¸´æ—¶éšœç¢æ”¯æŒï¼ˆå¦‚æŠ€èƒ½èŒƒå›´ï¼‰
- å®æ—¶é‡æ–°å¯»è·¯åˆ¤å®š

## ğŸ“š å‚è€ƒèµ„æ–™

- [War3 Movement System](https://www.codeofhonor.com/blog/the-algorithms-of-warcraft-3)
- [A* Pathfinding](https://www.redblobgames.com/pathfinding/a-star/introduction.html)
- [RVO (Reciprocal Velocity Obstacles)](http://gamma.cs.unc.edu/RVO/) - å•ä½é¿è®©ç®—æ³•
- [Steering Behaviors](https://www.red3d.com/cwr/steer/)

## ğŸ“ ç‰ˆæœ¬å†å²

### v1.1.0 (å½“å‰ç‰ˆæœ¬ - æœ€æ–°)
**æ ¸å¿ƒæ”¹è¿›ï¼šç›´çº¿è¿åŠ¨ä¼˜åŒ–å’Œ Bug ä¿®å¤**
- âœ… War3 é£æ ¼ç›´çº¿è¿åŠ¨ï¼šå…ˆå°è¯•ç›´çº¿èµ°åˆ°ç›®æ ‡ï¼Œæ¯å¸§æ£€æµ‹å‰æ–¹0.5méšœç¢
- âœ… åŠ¨æ€ A* åˆ‡æ¢ï¼šé‡åˆ°éšœç¢ç«‹å³åˆ‡æ¢ A* å¯»è·¯
- âœ… ä¿®å¤å¡ä½ bugï¼šå®Œæ•´å¤„ç† Blocked/Arrived çŠ¶æ€
- âœ… ç›®æ ‡æœå‘ä¿®æ­£ï¼šç›´çº¿è¿åŠ¨æ—¶æœå‘æœ€ç»ˆç›®æ ‡è€Œéä¸´æ—¶ç‚¹
- âœ… çŠ¶æ€è½¬æ¢ä¼˜åŒ–ï¼šçŠ¶æ€æœºå®Œæ•´å¤„ç†æ‰€æœ‰åˆ†æ”¯

### v1.0.0 
- âœ… A* å¯»è·¯ç®—æ³•
- âœ… è·¯å¾„å¹³æ»‘ï¼ˆè§†çº¿æ£€æµ‹ï¼‰
- âœ… å¹³æ»‘è½¬å‘
- âœ… ç²¾ç¡®åˆ°è¾¾åˆ¤å®š
- âœ… ç§»åŠ¨çŠ¶æ€ç®¡ç†
- âœ… ä¸ UnitCommandSystem é›†æˆ
- âœ… åœ°å›¾é˜»æŒ¡æ£€æµ‹

## ğŸ”— ç›¸å…³æ–‡ä»¶

- [MovementSystem.ts](./MovementSystem.ts) - ä¸»å®ç°æ–‡ä»¶ï¼ˆ597è¡Œï¼‰
- [Actor.ts](./Actor.ts) - å•ä½åŸºç±»ï¼ˆåŒ…å« radius å­—æ®µï¼‰
- [Map.ts](./Map.ts) - åœ°å›¾å’Œå¯»è·¯æ•°æ®
- [UnitCommandSystem.ts](./UnitCommandSystem.ts) - å‘½ä»¤ç³»ç»Ÿé›†æˆ
- [ModelConfig.ts](../config/ModelConfig.ts) - é…ç½®æ¥å£
